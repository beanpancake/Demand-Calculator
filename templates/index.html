<!doctype html>
<title>Demand Calculator</title>
<h1>Demand Calculator</h1>
{% if error %}
<p style="color:red;">{{ error }}</p>
{% endif %}
<form method="post">
  <label>Voltage:
    <input type="number" step="any" name="voltage" required value="{{ request.form.voltage or '240' }}">
  </label><br>

  <label>Area Unit:
    <select name="area_unit" id="area-unit">
      <option value="m2" {% if request.form.get('area_unit', 'm2') == 'm2' %}selected{% endif %}>m²</option>
      <option value="ft2" {% if request.form.get('area_unit') == 'ft2' %}selected{% endif %}>ft²</option>
    </select>
  </label><br>

  <label>Main Area (<span class="area-unit-label">m²</span>):
    <input type="number" step="any" name="area" required value="{{ request.form.area or '' }}">
  </label><br>

  <label>Range (A or W):
    <input type="text" name="range" value="{{ request.form.range or '' }}">
  </label><br>
  <label>Heating (A or W):
    <input type="text" name="heat" value="{{ request.form.heat or '' }}">
  </label><br>
  <label>AC (A or W):
    <input type="text" name="ac" value="{{ request.form.ac or '' }}">
  </label><br>
  <label>EVSE (A or W):
    <input type="text" name="evse" value="{{ request.form.evse or '' }}">
  </label><br>
  <label>Interlocked Heat/AC:
    <input type="checkbox" name="interlocked" {% if request.form.get('interlocked') %}checked{% endif %}>
  </label><br>

  <label>Additional Loads >1500W:</label><br>
  <div id="additional-main-fields">
    {% set adds = request.form.getlist('additional') + [''] %}
    {% for val in adds %}
      <input type="text" name="additional" value="{{ val }}"><br>
    {% endfor %}
  </div>

  <label>Tankless WH (A or W):
    <input type="text" name="tankless" value="{{ request.form.tankless or '' }}">
  </label><br>

  <label>Steamers/Pools/Spas:</label><br>
  <div id="sps-main-fields">
    {% set sps = request.form.getlist('sps') + [''] %}
    {% for val in sps %}
      <input type="text" name="sps" value="{{ val }}"><br>
    {% endfor %}
  </div>

  <label>Include Suite:
    <input type="checkbox" name="suite" id="suite-checkbox" {% if request.form.get('suite') %}checked{% endif %}>
  </label><br>

  <div id="suite-section" style="display:{% if request.form.get('suite') %}block{% else %}none{% endif %}; margin-left:20px;">
    <label>Suite Area (<span class="area-unit-label">m²</span>):
      <input type="number" step="any" name="suite_area" value="{{ request.form.suite_area or '' }}">
    </label><br>
    <label>Suite Range (A or W):
      <input type="text" name="suite_range" value="{{ request.form.suite_range or '' }}">
    </label><br>
    <label>Suite EVSE (A or W):
      <input type="text" name="suite_evse" value="{{ request.form.suite_evse or '' }}">
    </label><br>
    <label>Suite Additional Loads >1500W:</label><br>
    <div id="additional-suite-fields">
      {% set sadd = request.form.getlist('suite_additional') + [''] %}
      {% for val in sadd %}
        <input type="text" name="suite_additional" value="{{ val }}"><br>
      {% endfor %}
    </div>
    <label>Suite Tankless WH (A or W):
      <input type="text" name="suite_tankless" value="{{ request.form.suite_tankless or '' }}">
    </label><br>
    <label>Suite Steamers/Pools/Spas:</label><br>
    <div id="sps-suite-fields">
      {% set ssps = request.form.getlist('suite_sps') + [''] %}
      {% for val in ssps %}
        <input type="text" name="suite_sps" value="{{ val }}"><br>
      {% endfor %}
    </div>
  </div>

  <button type="submit">Calculate</button>
</form>

{% if result %}
<h2>Result</h2>
<p>{{ result['Final Calculated Load (W)'] }} W</p>
{% endif %}

<script>
function setupDynamic(containerId, name, max=10){
  const container=document.getElementById(containerId);
  function check(){
    const inputs=container.querySelectorAll('input[name="'+name+'"]');
    const last=inputs[inputs.length-1];
    if(last.value.trim()!=='' && inputs.length<max){
      const br=document.createElement('br');
      const inp=document.createElement('input');
      inp.type='text';
      inp.name=name;
      inp.addEventListener('input', check);
      container.appendChild(inp);
      container.appendChild(br);
    }
  }
  container.querySelectorAll('input[name="'+name+'"]').forEach(inp=>inp.addEventListener('input', check));
}

function updateAreaLabels(){
  const unit=document.getElementById('area-unit').value==='ft2'?'ft²':'m²';
  document.querySelectorAll('.area-unit-label').forEach(el=>el.textContent=unit);
}

function toggleSuite(){
  const section=document.getElementById('suite-section');
  const checked=document.getElementById('suite-checkbox').checked;
  section.style.display=checked?'block':'none';
}

document.addEventListener('DOMContentLoaded', function(){
  setupDynamic('additional-main-fields','additional');
  setupDynamic('sps-main-fields','sps');
  setupDynamic('additional-suite-fields','suite_additional');
  setupDynamic('sps-suite-fields','suite_sps');
  updateAreaLabels();
  toggleSuite();
  document.getElementById('area-unit').addEventListener('change', updateAreaLabels);
  document.getElementById('suite-checkbox').addEventListener('change', toggleSuite);
});
</script>

